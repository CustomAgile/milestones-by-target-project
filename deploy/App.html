<!DOCTYPE html>
<html>
<head>
    <title>Milestones by Project</title>
    <!--  (c) 2020 Custom Agile.  All Rights Reserved. -->
    <!--  Build Date: Thu Oct 22 2020 12:12:30 GMT-0400 (Eastern Daylight Time) -->
    <!--  Version: "0.1.1"-->
    <!--  Repository: "https:/github.com/CustomAgile/milestones-by-target-project"-->
    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomAgile.ui.picker.MultiSelectTimebox",{extend:"Rally.ui.picker.MultiObjectPicker",alias:"widget.customagilemultiselecttimebox",config:{remoteFilter:!0,maxLength:100,projects:null,pickerCfg:{cls:"multiselect-timebox-picker",minWidth:350},width:150,enableGrouping:!1,toggleOnClick:!0,timeboxStartDateField:"",timeboxEndDateField:""},initComponent(){Rally.ui.list.PagingToolbar.prototype.emptyMsg="No timeboxes",this.callParent(arguments),this.store||this.createStore()},triggerBlur(){const{picker:e}=this;e&&e.isVisible()&&(this.collapse(),this.callParent(arguments))},getMatchedTextHtml:e=>`<div class="timebox-name">${e.Name}</div>`,resetFilters(){},setValueBasedOnState(e=[]){const t=Ext.isString(e)?e.split(","):Ext.Array.from(e);!_.isEmpty(t)&&this.store&&this.store.isLoading()?this.store.on("load",()=>{this._selectValues(t)},this,{single:!0}):this._selectValues(t),this.isExpanded&&(this._onListRefresh(),this._groupSelectedRecords()),this.fireEvent("stateapplied",this,this.selectedValues.getRange(),null)},setDefaultValue(e){this._selectValues(e),this.fireEvent("defaultapplied",this,this.selectedValues.getRange(),null)},getTimeboxOidsInScope(e,t,i){if(e.length>0){let s={model:Ext.identityFn(this.modelType),filters:this._getTimeboxFilters(e),fetch:["Name",this.timeboxStartDateField,this.timeboxEndDateField,"ObjectID"],autoLoad:!0,listeners:{load:(e,s)=>{Ext.callback(t,i,[s])}}};this.projects&&(s.filters=s.filters.and({property:"Project.ObjectID",operator:"in",value:this.projects}),s.context={project:null}),Ext.create("Rally.data.wsapi.Store",s)}else Ext.callback(t,i,[[]])},_getTimeboxFilters(e){let t=[],i={};return _.each(e,e=>{let s=`${e.get("Name")}-${e.get(this.timeboxStartDateField)}-${e.get(this.timeboxEndDateField)}`;if(!i[s]){i[s]=!0;let l=Rally.data.wsapi.Filter.and([{property:"Name",value:e.get("Name")},{property:this.timeboxStartDateField,value:e.get(this.timeboxStartDateField)},{property:this.timeboxEndDateField,value:e.get(this.timeboxEndDateField)}]);t.push(l)}}),Rally.data.wsapi.Filter.or(t)},createStore(){if(!this.store){let e=Ext.create("Rally.data.DataStoreBuilder"),t=Ext.merge({model:this.modelType,requester:this},this.storeConfig);return e.build(t).then({success(e){this.store=e,this.relayEvents(this.store,["datachanged"])},scope:this})}return Promise.resolve(this.store)},_initInputEvents(){this.rendered?(this.on("expand",this.refreshView,this),this.mon(this.inputEl,"keydown",this._onInputKeyDown,this,{buffer:700}),this.mon(this.inputEl,"keyup",this.validate,this,{buffer:700}),this.mon(this.inputEl,"keyup",this._onInputKeyUp,this,{buffer:700})):this.on("afterrender",this._initInputEvents,this,{single:!0})},_onInputTextChanged(){this.store.clearFilter(),this.store.filter({anyMatch:!0,exactMatch:!1,property:"Name",value:this.getInputTextValue()}),this.store.load()},_onInputKeyUp(e){this._setAppropriateEmptyText(),!e.shiftKey&&Rally.util.Event.isModifierKey(e)||this._onInputTextChanged(),""===this.getInputTextValue()&&(this.store.filters&&this.store.filters.clear(),this.store.load())},_createList(){this.listCfg.pageSize=10;let e=Ext.apply({store:this.store,tpl:this._getListTpl(),createPagingToolbar:Ext.bind(this._createPagingToolbar,this)},this.listCfg);return this.list=Ext.create(this.listType,e),this.mon(this.list,{refresh:this._onListRefresh,select:this.onListItemSelect,deselect:this.onListItemDeselect,scope:this}),this.getList().down("rallylistpagingtoolbar").onLoad(),this.list},onListItemSelect(e,t){this.select(t),this._selectRowCheckbox(t.get(this.recordKey)),this._groupRecordsAndScroll(this._getRecordValue()),this.refreshView(),this.fireEvent("select",this,t,this.getValue()),this._fireSelectionChange()},onListItemDeselect(e,t){let i=null;const s=this._getKey(t);this.selectedValues.each(e=>{e.get("_ref")===s&&(i=e)}),i&&this.selectedValues.remove(i),this._syncSelection(),this._deselectRowCheckbox(t.get(this.recordKey)),this._groupRecordsAndScroll(this._getRecordValue()),this.fireEvent("deselect",this,t,this.getValue()),this._fireSelectionChange()},_deselectRowCheckbox(e){this._getOptionCheckbox(e)&&this._getOptionCheckbox(e).removeCls("rui-picker-cb-checked")},_onStoreLoaded(){this._syncSelection(),this.callParent(arguments)},_createPagingToolbar(){return Ext.widget("rallylistpagingtoolbar",{store:this.store,border:!1,layout:{align:"middle"}})}});
                Ext.define("CustomAgile.ui.picker.MultiSelectProject",{extend:"CustomAgile.ui.picker.MultiSelectTimebox",alias:"widget.customagilemultiselectproject",requires:["CustomAgile.ui.picker.MultiSelectTimebox"],config:{modelType:"Project",emptyText:"Search projects...",storeConfig:{autoLoad:!0,limit:10,pageSize:10,remoteSort:!0,remoteFilter:!0,fetch:["ObjectID","Name"],sorters:[{property:"Name",direction:"ASC"}],context:{project:null}}},initComponent(){this.callParent(arguments),Rally.ui.list.PagingToolbar.prototype.emptyMsg=`No ${this.modelType}s`},getFilter(){let e=this.getValue();return{property:"Project",operator:"in",value:_.map(e,e=>e.get("_ref"))}},getLookbackFilter(){let e=this.getValue();return{property:"Project",operator:"in",value:_.map(e,e=>e.get("ObjectID"))}}});
                Ext.define("Customagile.ui.PillPicker",{extend:"Ext.Container",alias:"widget.customagilepillpicker",pickerCfg:null,showPills:!0,statefulKey:null,sharedSchedules:!1,defaultToRecentTimeboxes:!0,initComponent(){let e=[];if(this.recordsToAdd=[],this.picker=Ext.ComponentManager.create(this.pickerCfg),this.mon(this.picker,"selectionchange",this._onSelectionChange,this),this.mon(this.picker,"select",this._onItemSelect,this),this.mon(this.picker,"deselect",this._onItemDeselect,this),this.mon(this.picker,"expand",this._onInitialExpand,this,{single:!0}),this.items=this._createItems(),this.statefulKey&&(e=JSON.parse(localStorage.getItem(this.statefulKey))),e&&e.length>0)Ext.create("Rally.data.wsapi.RefsToRecords").convert(e,{requester:this}).then({success:e=>{this.sharedSchedules?this.picker.getTimeboxOidsInScope(e,e=>{this.recordsToAdd=e,e&&e.length>0?(this.picker.setValueBasedOnState(e),this._addPills(e),this.saveStateLocal(e)):this._setDefaults()},this):(this.recordsToAdd=e,this.picker.setValueBasedOnState(e),this._addPills(e),this.saveStateLocal(e))},scope:this});else if(this.sharedSchedules){const e=this.picker.store.getRange(0,9);this.defaultToRecentTimeboxes?(this.recordsToAdd=e,this.picker.setDefaultValue(e)):(this.recordsToAdd=[],this.picker.setValueBasedOnState([]))}else this.picker.createStore().then(()=>{this._setDefaults()},e=>{console.log(e),this.picker.setDefaultValue([])});this.callParent(arguments),this.sharedSchedules&&this._addPills(this.recordsToAdd)},getValue(){const{picker:e}=this;return e?e.getValue():[]},getFilter(){return this.picker&&this.picker.getFilter()},getLookbackFilter(){return this.picker&&this.picker.getLookbackFilter()},saveStateLocal(e){if(this.statefulKey)try{localStorage.setItem(this.statefulKey,JSON.stringify(_.invoke(e,"get","_ref")))}catch(e){}},_onInitialDataChanged(){this._setDefaults()},_setDefaults(){0===this.recordsToAdd.length&&(this.defaultToRecentTimeboxes?Ext.create("Rally.data.wsapi.Store",{model:"Release",autoLoad:!0,limit:4,pageSize:4,remoteSort:!0,remoteFilter:!0,fetch:["ObjectID","Name","ReleaseStartDate","ReleaseDate"],sorters:[{property:"ReleaseDate",direction:"DESC"}],filters:[{property:"ReleaseStartDate",operator:"<",value:new Date}],context:{project:Rally.getApp().getContext().getProjectRef(),projectScopeUp:!1,projectScopeDown:!1},listeners:{scope:this,load:function(e,t,s){s?(this.picker.setDefaultValue(t),this._addPills(t)):this.picker.setDefaultValue([])}}}):this.picker.setValueBasedOnState([]))},_onInitialExpand(){this.picker.getList()&&(this.picker.getList().pagingToolbar.onLoad(),this.picker.getList().refresh())},_addPills(e){let t=e;if(!this.showPills)return;if(this.sharedSchedules){let s={};t=_.filter(e,e=>{let t=`${e.get("Name")}-${e.get(this.startDateFieldName)}-${e.get(this.endDateFieldName)}`;return!s[t]&&(s[t]=!0,!0)})}const s=_.map(t,e=>({xtype:"component",flex:1,itemId:`pill-id-${e.getId()}`,renderTpl:'<span class="tagPill">{Name}<span class="icon-cancel"></span></span>',renderData:e.getData(),renderSelectors:{tagPill:".tagPill",removePillEl:".icon-cancel"},listeners:{click:{element:"tagPill",fn:t=>{t.preventDefault(),this._onRemovePillClick(e)},scope:this}}}),this),i=_.filter(s,e=>_.isEmpty(this.down(`#${e.itemId}`)),this);i.length>0&&this.down("#pillContainer").add(i)},_createItems(){return[this.picker,{itemId:"pillContainer",xtype:"container",cls:"pill-select-container",margin:"10 0 0 0",layout:{type:"table",columns:3}}]},_removePills(){_.each(this.down("#pillContainer").items.getRange(),e=>{e.destroy()})},_removePill(e){let t=this.down(`#pill-id-${e.getId()}`);t&&t.destroy()},_onSelectionChange(e,t){Ext.suspendLayouts(),this._removePills(),this._addPills(t),Ext.resumeLayouts(!0),this.saveStateLocal(t)},_onItemSelect(e,t){this._addPills(Ext.Array.from(t))},_onItemDeselect(e,t){this._removePill(t)},_findSharedSchedules(e){const t=this.picker.selectedValues.getRange(),s=`${e.get("Name")}-${e.get(this.startDateFieldName)}-${e.get(this.endDateFieldName)}`;return _.filter(t,e=>{return`${e.get("Name")}-${e.get(this.startDateFieldName)}-${e.get(this.endDateFieldName)}`===s})},_onRemovePillClick(e){if(this.sharedSchedules){const t=this._findSharedSchedules(e);_.each(t,e=>{this.picker.onListItemDeselect(null,e),this._removePill(e)})}else this.picker.onListItemDeselect(null,e),this._removePill(e);this.saveStateLocal(this.picker.selectedValues.getRange()),this.fireEvent("recordremoved",this.picker.selectedValues,e,this.picker)},_setPillsFromPrjRef(e){return new Promise(t=>{Ext.create("Rally.data.wsapi.RefsToRecords").convert(e,{requester:this}).then({success:e=>{this.recordsToAdd=e,e&&e.length>0?(this.picker.setValueBasedOnState(e),this._addPills(e),this.saveStateLocal(e)):this._setDefaults(),t()},failure:e=>{console.log(e),t()},scope:this})})}});
                Ext.define("Customagile.ui.ProjectPicker",{extend:"Ext.Container",alias:"widget.customagileprojectpicker",layout:"vbox",cmp:null,appName:"",tab:null,initComponent(){this.callParent(arguments),this.add([{xtype:"customagilepillpicker",itemId:"projectPicker",hidden:!1,statefulKey:this.cmp.getContext().getScopedStateId(this.appName+"-project-picker"),defaultToRecentTimeboxes:!1,listeners:{recordremoved:this.showApplyProjectsBtn,scope:this},pickerCfg:{xtype:"customagilemultiselectproject",width:350,margin:"10 0 0 0",listeners:{stateapplied:()=>this._onReady(),defaultapplied:()=>this._onReady(),blur:this.showApplyProjectsBtn,scope:this}}},{xtype:"rallycheckboxfield",itemId:"includeChildProjectsCheckbox",fieldLabel:"Show work from child projects",labelSeparator:"",stateful:!0,stateId:this.cmp.getContext().getScopedStateId(this.appName+"-scope-down-checkbox"),stateEvents:["change"],labelWidth:200,listeners:{scope:this,change:this.showApplyProjectsBtn}}]),this.projectPicker=this.down("#projectPicker")},_onReady(){setTimeout(()=>this.updateProjectTabText(),1e3),setTimeout(()=>this.fireEvent("ready"),200)},showApplyProjectsBtn(){},updateProjectTabText(){if(this.tab)if(this.cmp.down("#ignoreScopeControl")&&"workspace"===this.cmp.down("#ignoreScopeControl").getValue())this.tab.setTitle("PROJECTS (ALL)");else if(this.projectPicker&&!this.projectPicker.hidden){let e=this.projectPicker.getValue().length,t=e?`PROJECTS (${e})`:"PROJECTS";this.tab.setTitle(t)}else this.tab.setTitle("PROJECTS")},getValue(){return this.projectPicker.getValue()},includeChildProjects(){return this.down("#includeChildProjectsCheckbox").getValue()},setIncludeChildProjects(e){this.down("#includeChildProjectsCheckbox").setValue(e)},reset(){this.projectPicker._removePills(),this.projectPicker.picker.setValueBasedOnState([]),this.projectPicker.saveStateLocal([]),this.updateProjectTabText(),this.down("#includeChildProjectsCheckbox").setValue(!1),this.projectPicker.picker.setDefaultValue([])},getProjectRefs(){return _.map(this.projectPicker.getValue(),e=>e.get("_ref"))},async setValueFromPrjRef(e,t){this.setIncludeChildProjects(t),await this.projectPicker._setPillsFromPrjRef(e)},async updatePickerFromOldPicker(e,t){let i=JSON.parse(localStorage.getItem(this.cmp.getContext().getScopedStateId(e+"-project-picker")));i&&i.length>0&&await this.setValueFromPrjRef(i,t),localStorage.removeItem(this.cmp.getContext().getScopedStateId(e+"-project-picker"))}});
                Ext.define("CustomAgile.ui.popover.SummaryGridPopover",{alias:"widget.summarygridpopover",extend:"Rally.ui.popover.Popover",id:"grid-popover",cls:"grid-popover",title:"Collection Details",width:750,maxHeight:600,layout:"fit",constructor:function(t){t.title&&(this.title=t.title);let e=[{xtype:"rallygrid",itemId:"listview",store:t.store,storeConfig:{fetch:t.fetch,sorters:t.sorters},columnCfgs:t.columns,sortableColumns:!0,showRowActionsColumn:!1,showPagingToolbar:!0,enableEditing:!1,flex:1,overflowY:"auto"}];t.items=Ext.merge(e,t.items),this.callParent(arguments)},getGrid:function(){return this.down("#listview")}});
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",layout:{type:"vbox",align:"stretch"},items:[{id:"dropdownFiltersContainer",xtype:"container",margin:10,layout:{type:"hbox",defaultMargins:"0 30 0 0"}},{id:"mainContainer",xtype:"container",flex:1,layout:{type:"vbox",align:"stretch",defaultMargins:5}}],launch(){Rally.data.wsapi.Proxy.superclass.timeout=12e4,this.down("#mainContainer").on("resize",this.onGridResize);let e=this.getContext();Ext.override(Ext.form.field.Checkbox,{getState:function(){return{checked:this.getValue()}},applyState:function(e){"boolean"==typeof e.checked&&this.setValue(e.checked)}}),this.down("#dropdownFiltersContainer").add([{xtype:"customagileprojectpicker",cmp:this,appName:"milestones-by-target-project",listeners:{scope:this,ready:()=>this._onProjectSelected(),applyprojects:()=>this._onProjectSelected()}},{xtype:"container",layout:"vbox",items:[{xtype:"rallytextfield",itemId:"idFilter",fieldLabel:"ID",labelSeparator:"",stateful:!0,stateId:e.getScopedStateId("id-filter"),stateEvents:["change"]},{xtype:"rallyfieldvaluecombobox",itemId:"milestoneTypeFilter",model:"Milestone",field:"c_Type",fieldLabel:"Type",labelSeparator:"",stateful:!0,stateId:e.getScopedStateId("milestone-type"),stateEvents:["change"]},{xtype:"rallyfieldvaluecombobox",itemId:"milestoneActiveFilter",model:"Milestone",field:"c_Active",fieldLabel:"Active",labelSeparator:"",allowBlank:!0,allowNoEntry:!0,stateful:!0,stateId:e.getScopedStateId("milestone-active"),stateEvents:["change"]}]},{xtype:"container",layout:"vbox",items:[{xtype:"checkboxfield",itemId:"archivedProjectsFilter",fieldLabel:"Has archived projects",width:200,labelWidth:175,labelSeparator:"",stateful:!0,stateId:e.getScopedStateId("has-archived-projects"),stateEvents:["change"]},{xtype:"checkboxfield",itemId:"archivedArtifactsFilter",fieldLabel:"Has archived Artifacts",width:200,labelWidth:175,labelSeparator:"",stateful:!0,stateId:e.getScopedStateId("has-archived-artifacts"),stateEvents:["change"]}]},{xtype:"container",layout:"vbox",items:[{xtype:"rallybutton",itemId:"applySettingsBtn",text:"Apply Settings",handler:()=>this._onProjectSelected()}]}]),this.projectPicker=this.down("customagileprojectpicker")},async addGrid(){let e=this.getContext().getDataContext();this.setLoading(!0);try{this.down("#mainContainer").add({xtype:"rallygrid",editable:!1,storeConfig:{filters:await this.getFilters(),model:"milestone",context:e,enablePostGet:!0},height:this.down("#mainContainer").getHeight(),columnCfgs:["FormattedID","Name",{dataIndex:"Projects",text:"All Projects",flex:1,renderer:function(e,t,r){return`<a onclick="Rally.getApp().showCollectionGrid(event,${r.get("ObjectID")}, 'Projects'); return false;">\n                                        <span class="grid-link">${e.Count}</span>\n                                    </a>`}},{dataIndex:"Artifacts",text:"All Artifacts",flex:1,renderer:function(e,t,r){return`<a onclick="Rally.getApp().showCollectionGrid(event,${r.get("ObjectID")}, 'Artifacts'); return false;">\n                                        <span class="grid-link">${e.Count}</span>\n                                    </a>`}},"TargetDate","c_Type","c_Active"]})}catch(e){this.showError(e)}this.setLoading(!1)},_onProjectSelected(){this.down("#mainContainer").removeAll(),this.addGrid()},showCollectionGrid(e,t,r){this.setLoading(`Loading ${r}`);try{let i=this.down("rallygrid").store.getById(t);if(i){let t=[],a=[],o=[];"Projects"===r?(t=["Name","Owner","Archived"],a=["Name","Owner","Archived"],o=["Name"]):"Artifacts"===r&&(t=["FormattedID","Name","Project"],a=["FormattedID","Name","Project"],o=["FormattedID"]);let s=i.getCollection(r);return Ext.create(CustomAgile.ui.popover.SummaryGridPopover,{title:r,target:e.target,placement:["bottom","top"],offsetFromTarget:[{x:0,y:-5},{x:5,y:0},{x:0,y:5},{x:-5,y:0}],models:["Project"],store:s,fetch:t,sorters:o,maxWidth:this.down("rallygrid").getWidth(),columns:a}),this.setLoading(!1),!1}}catch(e){this.showError(e)}},async getFilters(){let e=[],t=await this.getProjects();return t.length&&e.push({property:"Projects",operator:t.length>1?"in":"=",value:t.length>1?t:t[0]}),this.down("#idFilter").getValue()&&e.push({property:"FormattedID",operator:"contains",value:this.down("#idFilter").getValue()}),this.down("#milestoneTypeFilter").getValue()&&e.push({property:"c_Type",value:this.down("#milestoneTypeFilter").getValue()}),this.down("#milestoneActiveFilter").getValue()&&e.push({property:"c_Active",value:this.down("#milestoneActiveFilter").getValue()}),this.down("#archivedProjectsFilter").getValue()&&e.push({property:"Projects.c_Archived",value:"Yes"}),this.down("#archivedArtifactsFilter").getValue()&&e.push({property:"Artifacts.Project.c_Archived",value:"Yes"}),e},async getProjects(){let e=this.projectPicker.getValue()||[];return this.projectPicker.includeChildProjects()&&(e=await this.getAllChildProjects(e)),_.map(e,e=>e.get("_ref"))},async getAllChildProjects(e=[],t=["Name","Children","ObjectID"]){if(!e.length)return[];const r=e.map(e=>this.wrap(e.getCollection("Children",{fetch:t,limit:1/0,filters:[{property:"State",value:"Open"}]}).load())),i=_.flatten(await Promise.all(r)),a=await this.getAllChildProjects(i,t),o={};let s=_.flatten([...a,...e,...i]);return s.forEach(e=>o[e.get("_ref")]=e),s=Object.values(o)},onGridResize(){let e=this.down("rallygrid");e&&e.setHeight(this.getHeight())},setLoading(e){this.down("#mainContainer").setLoading(e)},showError(e){this.setLoading(!1),Rally.ui.notify.Notifier.showError({message:this.parseError(e)})},parseError(e,t){if("string"==typeof e&&e.length)return e;if(e.message&&e.message.length)return e.message;if(e.exception&&e.error&&e.error.errors&&e.error.errors.length){if(e.error.errors[0].length)return e.error.errors[0];if(e.error&&e.error.response&&e.error.response.status)return`${t} (Status ${e.error.response.status})`}return e.exceptions&&e.exceptions.length&&e.exceptions[0].error?e.exceptions[0].error.statusText:t},wrap:async e=>e&&_.isFunction(e.then)?new Promise((t,r)=>{e.then({success(...e){t(...e)},failure(e){Rally.getApp().setLoading(!1),r(e)}})}):Promise.reject(new Error("Wrap cannot process this type of data into a ECMA promise"))});

            Rally.launchApp('CustomApp', {
                name:"Milestones by Project",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        .grid-link{color:#337ec6;cursor:pointer}.x-form-item-label{font-family:"Open Sans",-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol" !important;color:#58606e !important;font-size:14px !important}
    </style>
</head>
<body>
</body>
</html>
